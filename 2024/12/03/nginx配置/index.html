<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>nginx配置 - wanghuan</title><link rel="manifest" href="/note/manifest.json"><meta name="application-name" content="wanghuan"><meta name="msapplication-TileImage" content="/img/logo.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="wanghuan"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Nginx安装 在&amp;#x2F;usr&amp;#x2F;local目录下执行yum install -y nginx； 通过systemctl start nginx启动nginx； 通过systemctl enable nginx 设置开启启动；"><meta property="og:type" content="blog"><meta property="og:title" content="nginx配置"><meta property="og:url" content="https://ihuan123.github.io/note/2024/12/03/nginx%E9%85%8D%E7%BD%AE/"><meta property="og:site_name" content="wanghuan"><meta property="og:description" content="Nginx安装 在&amp;#x2F;usr&amp;#x2F;local目录下执行yum install -y nginx； 通过systemctl start nginx启动nginx； 通过systemctl enable nginx 设置开启启动；"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://ihuan123.github.io/note/img/og_image.png"><meta property="article:published_time" content="2024-12-03T13:27:00.000Z"><meta property="article:modified_time" content="2024-12-04T04:02:58.671Z"><meta property="article:author" content="wanghuan"><meta property="article:tag" content="nginx"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://ihuan123.github.io/note/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ihuan123.github.io/note/2024/12/03/nginx%E9%85%8D%E7%BD%AE/"},"headline":"nginx配置","image":["https://ihuan123.github.io/note/img/og_image.png"],"datePublished":"2024-12-03T13:27:00.000Z","dateModified":"2024-12-04T04:02:58.671Z","author":{"@type":"Person","name":"IHuan123"},"publisher":{"@type":"Organization","name":"wanghuan","logo":{"@type":"ImageObject","url":"https://ihuan123.github.io/img/logo.svg"}},"description":"Nginx安装 在&#x2F;usr&#x2F;local目录下执行yum install -y nginx； 通过systemctl start nginx启动nginx； 通过systemctl enable nginx 设置开启启动；"}</script><link rel="canonical" href="https://ihuan123.github.io/note/2024/12/03/nginx%E9%85%8D%E7%BD%AE/"><link rel="icon" href="/note/img/logo.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/note/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }
          Array
              .from(document.querySelectorAll('.tab-content'))
              .forEach($tab => {
                  $tab.classList.add('is-hidden');
              });
          Array
              .from(document.querySelectorAll('.tabs li'))
              .forEach($tab => {
                  $tab.classList.remove('is-active');
              });
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.1.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/note/"><img src="/note/img/logo.svg" alt="wanghuan" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/note/">首页</a><a class="navbar-item" href="/note/archives">归档</a><a class="navbar-item" href="/note/categories">目录</a><a class="navbar-item" href="/note/tags">标签</a><a class="navbar-item" href="/note/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/IHuan123"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal"><i class="fas fa-angle-double-right"></i>nginx配置</h1><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2024-12-03T13:27:00.000Z" title="2024/12/3 21:27:00">2024-12-03</time>发表</span><span class="level-item"><time dateTime="2024-12-04T04:02:58.671Z" title="2024/12/4 12:02:58">2024-12-04</time>更新</span><span class="level-item"><a class="link-muted" href="/note/categories/nginx/">nginx</a></span><span class="level-item">1 小时读完 (大约7997个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><div class="content"><h2 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h2><ul>
<li>在&#x2F;usr&#x2F;local目录下执行<code>yum install -y nginx</code>；</li>
<li>通过<code>systemctl start nginx</code>启动nginx；</li>
<li>通过<code>systemctl enable nginx</code> 设置开启启动；</li>
</ul>
<span id="more"></span>

<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">nginx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">立即停止</span></span><br><span class="line">nginx -s stop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行完当前请求再停止</span></span><br><span class="line">nginx -s quit</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新加载配置文件，相当于restart</span></span><br><span class="line">nginx -s reload</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将日志写入一个新的文件</span></span><br><span class="line">nginx -s reopen</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">测试配置文件</span></span><br><span class="line">nginx -t</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开启启动</span></span><br><span class="line">systemctl enable nginx</span><br></pre></td></tr></table></figure>

<p>日志位于<code>/var/log/nginx</code>。</p>
<h2 id="默认配置文件"><a href="#默认配置文件" class="headerlink" title="默认配置文件"></a>默认配置文件</h2><p>nginx默认配置文件在<code>/etc/nginx/nginx.conf</code>中。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">user</span> www-data;</span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">pid</span> /run/nginx.pid;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/<span class="literal">error</span>.log;</span><br><span class="line"><span class="attribute">include</span> /etc/nginx/modules-enabled/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">	<span class="attribute">worker_connections</span> <span class="number">768</span>;</span><br><span class="line">	<span class="comment"># multi_accept on;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># Basic Settings</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	<span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">	<span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">	<span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line">	<span class="comment"># server_tokens off;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># server_names_hash_bucket_size 64;</span></span><br><span class="line">	<span class="comment"># server_name_in_redirect off;</span></span><br><span class="line"></span><br><span class="line">	<span class="attribute">include</span> /etc/nginx/mime.types;</span><br><span class="line">	<span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># SSL Settings</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	<span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>; <span class="comment"># Dropping SSLv3, ref: POODLE</span></span><br><span class="line">	<span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># Logging Settings</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	<span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># Gzip Settings</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	<span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># gzip_vary on;</span></span><br><span class="line">	<span class="comment"># gzip_proxied any;</span></span><br><span class="line">	<span class="comment"># gzip_comp_level 6;</span></span><br><span class="line">	<span class="comment"># gzip_buffers 16 8k;</span></span><br><span class="line">	<span class="comment"># gzip_http_version 1.1;</span></span><br><span class="line">	<span class="comment"># gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line">	<span class="comment"># Virtual Host Configs</span></span><br><span class="line">	<span class="comment">##</span></span><br><span class="line"></span><br><span class="line">	<span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">	<span class="attribute">include</span> /etc/nginx/sites-enabled/*;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在最后两行通过 <code>include /xx/xx</code>引入了其他的配置，<code>include /etc/nginx/conf.d/*.conf;</code>引入了<code>/etc/nginx/conf.d</code>下所有的conf文件配置，这里可以配置我们自己的代理配置。</p>
<p>在<code>/etc/nginx/sites-enabled/</code>下的default为nginx的默认配置。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="comment"># You should look at the following URL&#x27;s in order to grasp a solid understanding</span></span><br><span class="line"><span class="comment"># of Nginx configuration files in order to fully unleash the power of Nginx.</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/</span></span><br><span class="line"><span class="comment"># https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/</span></span><br><span class="line"><span class="comment"># https://wiki.debian.org/Nginx/DirectoryStructure</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In most cases, administrators will remove this file from sites-enabled/ and</span></span><br><span class="line"><span class="comment"># leave it as reference inside of sites-available where it will continue to be</span></span><br><span class="line"><span class="comment"># updated by the nginx packaging team.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file will automatically load configuration files provided by other</span></span><br><span class="line"><span class="comment"># applications, such as Drupal or Wordpress. These applications will be made</span></span><br><span class="line"><span class="comment"># available underneath a path with that package name, such as /drupal8.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Default server configuration</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">	<span class="attribute">listen</span> [::]:<span class="number">80</span> default_server;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># SSL configuration</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># listen 443 ssl default_server;</span></span><br><span class="line">	<span class="comment"># listen [::]:443 ssl default_server;</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># Note: You should disable gzip for SSL traffic.</span></span><br><span class="line">	<span class="comment"># See: https://bugs.debian.org/773332</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># Read up on ssl_ciphers to ensure a secure configuration.</span></span><br><span class="line">	<span class="comment"># See: https://bugs.debian.org/765782</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># Self signed certs generated by the ssl-cert package</span></span><br><span class="line">	<span class="comment"># Don&#x27;t use them in a production server!</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># include snippets/snakeoil.conf;</span></span><br><span class="line"></span><br><span class="line">	<span class="attribute">root</span> /var/www/html;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># Add index.php to the list if you are using PHP</span></span><br><span class="line">	<span class="attribute">index</span> index.html index.htm index.nginx-debian.html;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">server_name</span> _;</span><br><span class="line"></span><br><span class="line">	<span class="section">location</span> / &#123;</span><br><span class="line">		<span class="comment"># First attempt to serve request as file, then</span></span><br><span class="line">		<span class="comment"># as directory, then fall back to displaying a 404.</span></span><br><span class="line">		<span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ =<span class="number">404</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># pass PHP scripts to FastCGI server</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">	<span class="comment">#	include snippets/fastcgi-php.conf;</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment">#	# With php-fpm (or other unix sockets):</span></span><br><span class="line">	<span class="comment">#	fastcgi_pass unix:/run/php/php7.4-fpm.sock;</span></span><br><span class="line">	<span class="comment">#	# With php-cgi (or other tcp sockets):</span></span><br><span class="line">	<span class="comment">#	fastcgi_pass 127.0.0.1:9000;</span></span><br><span class="line">	<span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># deny access to .htaccess files, if Apache&#x27;s document root</span></span><br><span class="line">	<span class="comment"># concurs with nginx&#x27;s one</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">	<span class="comment">#	deny all;</span></span><br><span class="line">	<span class="comment">#&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Virtual Host configuration for example.com</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You can move that to a different file under sites-available/ and symlink that</span></span><br><span class="line"><span class="comment"># to sites-enabled/ to enable it.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#server &#123;</span></span><br><span class="line"><span class="comment">#	listen 80;</span></span><br><span class="line"><span class="comment">#	listen [::]:80;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	server_name example.com;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	root /var/www/example.com;</span></span><br><span class="line"><span class="comment">#	index index.html;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	location / &#123;</span></span><br><span class="line"><span class="comment">#		try_files $uri $uri/ =404;</span></span><br><span class="line"><span class="comment">#	&#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当访问[:80]端口会指向&#x2F;var&#x2F;www&#x2F;html&#x2F;index.nginx-debian.html&#96;页面资源。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>将配置文件放入<code>/etc/nginx/conf.d</code>目录下可以保持主配置文件的简洁，同时配多个.conf文件方便管理，增加可读性。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="comment"># 虚拟主机</span></span><br><span class="line">  <span class="section">server</span> &#123; </span><br><span class="line">      <span class="comment"># 监听请求端口</span></span><br><span class="line">      <span class="attribute">listen</span> <span class="number">80</span>; </span><br><span class="line">      <span class="comment"># 虚拟主机名称命名</span></span><br><span class="line">      <span class="attribute">server_name</span> localhost;</span><br><span class="line"></span><br><span class="line">      <span class="section">location</span> / &#123;</span><br><span class="line">      		<span class="comment"># 代理的资源地址目录</span></span><br><span class="line">          <span class="attribute">root</span> /home/www/tab/test/dist;</span><br><span class="line">      		<span class="comment"># 访问index时指向的文件</span></span><br><span class="line">          <span class="attribute">index</span> index.html;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 多个server</span></span><br><span class="line">  server&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果在访问中出现问题，可查看错误日志<code>/var/log/nginx/error.log</code>;如何出现<code>13:Permission denied</code>等错误信息一般是由文件权限问题或者selinux的安全策略引起的。</p>
<ul>
<li><p>listen：</p>
<blockquote>
<p>监听可配置成IP或者IP+端口，例如<code>127.0.0.1:8000</code>、<code>listen 127.0.0.1</code>（没有端口默认为80）、<code>listen 8000</code>、<code>listen *:8000</code>、<code>listen localhost:8000</code>。</p>
</blockquote>
</li>
<li><p>server_name</p>
<blockquote>
<p>主要用于区分虚拟主机，可按照自己的命名习惯进行命名，也可以使用变量<code>$hostname</code>配置成主机名，或者配置成域名：<code>example.com</code>，如果多个server的端口重复，那么根据域名或者主机名取匹配server_name进行选择：</p>
<p>例如：</p>
<p>curl <a target="_blank" rel="noopener" href="http://localhost/">http://localhost:80</a> 会访问&#x2F;home&#x2F;dome1</p>
<p>curl <a href="http://nginx-dev:80会访问/home/dome2">http://nginx-dev:80会访问/home/dome2</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> &gt;<span class="section">server</span> &#123; </span><br><span class="line">   <span class="attribute">listen</span> <span class="number">8081</span>;</span><br><span class="line">   <span class="attribute">server_name</span> localhost;</span><br><span class="line">   <span class="section">location</span> / &#123;</span><br><span class="line">       <span class="attribute">root</span> /home/demo1;</span><br><span class="line">       <span class="attribute">index</span> index.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"> &gt;<span class="section">server</span> &#123; </span><br><span class="line">   <span class="attribute">listen</span> <span class="number">8082</span>;</span><br><span class="line">   <span class="attribute">server_name</span> nginx-dev;</span><br><span class="line">   <span class="section">location</span> / &#123;</span><br><span class="line">       <span class="attribute">root</span> /home/demo2;</span><br><span class="line">       <span class="attribute">index</span> index.html;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>location</p>
<blockquote>
<p><code>/</code>请求指向 root 根目录</p>
<p>location 总是从<code>/</code>目录开始匹配，如果有子目录，例如<code>/css</code>，他会指向<code>/static/css</code>；</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /css&#123;</span><br><span class="line">  <span class="attribute">root</span> /static;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote>
</li>
</ul>
<h2 id="HTTP反向代理"><a href="#HTTP反向代理" class="headerlink" title="HTTP反向代理"></a>HTTP反向代理</h2><p>在客户端代理转发请求为正向代理，例如VPN，在服务器代理转发请求称为反向代理，例如nginx。</p>
<h3 id="proxy-pass"><a href="#proxy-pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h3><p>将服务器在&#x2F;some&#x2F;path&#x2F;上收到的请求指向<code>http://locahost:8080</code>地址：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /some/path/ &#123;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://locahost:8080</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>proxy-pass</code>的地址只配置到端口，不包含<code>/</code>或其他路径，那么location将被追加到转发地址中如上所示，访问 <code>http://localhost/some/path/page.html</code> 将被代理到 <code>http://localhost:8080/some/path/page.html</code></p>
<p>如何<code>proxy_pass</code>的地址中带有&#x2F;path信息，那么代理的地址在访问时会被替换掉，例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /some/path/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8080/zh-cn/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 <code>http://localhost/some/path/page.html</code> 将被代理到 <code>http://localhost:8080/zh-cn/page.html</code></p>
<h3 id="设置headers代理请求"><a href="#设置headers代理请求" class="headerlink" title="设置headers代理请求"></a>设置headers代理请求</h3><p>用户可以自定义请求头也可以追加请求信息到请求中，可以包含文本、变量等。默认情况下仅重新定义两个字段：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> Host <span class="variable">$proxy_host</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> Connection close;</span><br></pre></td></tr></table></figure>

<p>由于使用反向代理之后，服务器无法获取客户端请求的真实IP地址，获取的是代理服务器的IP地址，所以，一般反向代理都会将客户端请求地址设置到请求头中：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">  <span class="comment"># nginx的主机地址</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 用户的IP地址</span></span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> X-Forward-For <span class="variable">$proxy_add_x_forworded_for</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">proxy_pass</span> http://localhost:80</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>常用的变量：</p>
<ul>
<li><code>$host</code>:nginx主机IP，例如：192.168.xxx.xxx</li>
<li><code>$http_host</code>:nginx主机IP和端口，例如：192.168.xxx.xxx:8080</li>
<li><code>$proxy_host</code>:localhost:80，代理指向的地址即proxy_pass里配置的主机名和端口。</li>
<li><code>$remote_addr</code>:客户端真是IP。</li>
</ul>
<h3 id="非HTTP代理"><a href="#非HTTP代理" class="headerlink" title="非HTTP代理"></a>非HTTP代理</h3><p>如果要将请求传递到非 HTTP 代理服务器，可以使用下列指令：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_fastcgi_module.html#fastcgi_pass">fastcgi_pass</a> 将请求转发到FastCGI服务器（多用于PHP）</li>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_scgi_module.html#scgi_pass">scgi_pass</a> 将请求转发到SCGI server服务器（多用于PHP）</li>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_uwsgi_module.html#uwsgi_pass">uwsgi_pass</a> 将请求转发到uwsgi服务器（多用于python）</li>
<li><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_memcached_module.html#memcached_pass">memcached_pass</a> 将请求转发到memcached服务器</li>
</ul>
<h2 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h2><p>当项目存在静态资源时，可以将静态资源单独提取处理进行代理缓存。</p>
<p>例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  <span class="comment"># 接口等请求代理至项目地址</span></span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8080/;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment"># 字体文件、js、css等这些资源进行单独代理，方便后面做缓存处理</span></span><br><span class="line">  <span class="section">location</span><span class="regexp"> ^~</span> /fonts/ &#123;</span><br><span class="line">    <span class="attribute">root</span>  /home/www/static;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">location</span> <span class="regexp">~ \.(css|js|png|jpg|gif|ico)</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /home/www/static;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="location"><a href="#location" class="headerlink" title="location"></a>location</h3><ul>
<li><p>location可以用修饰符或者正则表达式匹配：</p>
<blockquote>
<p>&#x3D;：等于，严格匹配，匹配优先级最高；</p>
<p>^~：表示普通匹配，使用前缀匹配，如果匹配成功，则不再匹配其他location，优先级第二；</p>
<p>~：区分大小写；</p>
<p>~*：不区分大小写。</p>
</blockquote>
</li>
<li><p>优先级（从高到底）：</p>
<blockquote>
<p>1、精准匹配（&#x3D;）；</p>
<p>2、前缀匹配（^~）；</p>
<p>3、正则匹配（<del>和</del>*）；</p>
<p>4、不写</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span><span class="regexp"> ^~</span> /images/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ \.jpg</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上所示：</p>
<p>&#x2F;images&#x2F;1.jpg<code>代理到 </code><a target="_blank" rel="noopener" href="http://localhost:8080/images/1.jpg">http://localhost:8080/images/1.jpg</a><br>&#x2F;some&#x2F;path&#x2F;1.jpg<code> 代理到</code><a target="_blank" rel="noopener" href="http://localhost:8080/some/path/1.jpg">http://localhost:8080/some/path/1.jpg</a></p>
</li>
</ul>
<h2 id="缓冲（buffer）、缓存（cache）"><a href="#缓冲（buffer）、缓存（cache）" class="headerlink" title="缓冲（buffer）、缓存（cache）"></a>缓冲（buffer）、缓存（cache）</h2><h3 id="缓冲（buffer）"><a href="#缓冲（buffer）" class="headerlink" title="缓冲（buffer）"></a>缓冲（buffer）</h3><p>​        缓冲是将请求内容存储在内存中，如何请求的资源不合适放在内存中（比如超过了指定大小），则会将响应写入磁盘临时文件中。启用缓冲后，nginx先将后端请求响应（response）放入缓冲区，等请求完成后，在发送给客户端。</p>
<p>​        如果禁用了缓冲，则在客户端从代理服务器接收响应时，响应将同步发送到客户端。对于需要尽快开始接收响应的快速交互式客户端，此行为可能是可取的。这就会带来一个问题：因为客户端到nginx的网速过慢，导致nginx只能以一个较慢的速度将响应传给客户端；进而导致后端server也只能以同样较慢的速度传递响应给nginx，造成一次请求连接耗时过长。在高并发的情况下，后端server可能会出现大量的连接积压，最终拖垮server端。</p>
<p>​        开启代理缓冲后，nginx可以用较快的速度尽可能将响应体读取并缓冲到本地内存或磁盘中，然后同时根据客户端的网络质量以合适的网速将响应传递给客户端。这样既解决了server端连接过多的问题，也保证了能持续稳定的像客户端传递响应。</p>
<h4 id="proxy-buffering"><a href="#proxy-buffering" class="headerlink" title="proxy_buffering"></a>proxy_buffering</h4><p>关于proxy_buffering配置，nginx默认为启用<code>on</code>,若需要关闭则设为<code>off</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_buffering</span> <span class="literal">off</span>; <span class="comment"># on启用，off关闭</span></span><br></pre></td></tr></table></figure>

<h4 id="proxy-buffers"><a href="#proxy-buffers" class="headerlink" title="proxy_buffers"></a>proxy_buffers</h4><p>该指令设置每个连接读取响应的缓冲区的大小和数量。默认情况下，缓冲区大小等于一个内存页，4K 或 8K，具体取决于操作系统。</p>
<p>来自后端服务器响应的第一部分存储在单独的缓冲区中，其大小通过 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffer_size">proxy_buffer_size</a> 指令进行设置，此部分通常是相对较小的响应headers，通常将其设置成小于默认值。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_buffers</span> <span class="number">16</span> <span class="number">4k</span>;</span><br><span class="line">    <span class="attribute">proxy_buffer_size</span> <span class="number">2k</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8088;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果整个响应不适合存到内存里，则将其中的一部分保存到磁盘上的‎‎临时文件中‎‎。</p>
<p>‎<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_max_temp_file_size">‎proxy_max_temp_file_size‎</a>‎设置临时文件的最大值。</p>
<p>‎<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_temp_file_write_size">‎proxy_temp_file_write_size‎</a>‎设置一次写入临时文件的大小。</p>
<h3 id="缓存（cache）"><a href="#缓存（cache）" class="headerlink" title="缓存（cache）"></a>缓存（cache）</h3><p>启用缓存后，nginx将响应保存在磁盘中，返回给客户端的数据首先从缓存中获取，这样子相同的请求不用每次都发送给后端服务器，减少到后端请求的数量。</p>
<p>启用缓存，需要在http上下文中使用 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path">proxy_cache_path</a> 指令，定义缓存的本地文件目录，名称和大小。</p>
<p>缓存区可以被多个server共享，使用<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache">proxy_cache</a> 指定使用哪个缓存区。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_cache_path</span> /data/nginx/cache keys_zone=mycache:<span class="number">10m</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">proxy_cache</span> mycache;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://localhost:8000;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>缓存目录的文件名是 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_key">proxy_cache_key</a> 的MD5值。 </p>
<p>例如：<code>/data/nginx/cache/c/29/b7f54b2df7773722d382f4809d650**29c**</code></p>
<p><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_key">proxy_cache_key</a> 默认设置如下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_key</span> <span class="variable">$scheme</span><span class="variable">$proxy_host</span><span class="variable">$uri</span><span class="variable">$is_args</span><span class="variable">$args</span>;</span><br></pre></td></tr></table></figure>

<p>也可以自定义缓存的键，例如</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_key</span> <span class="string">&quot;<span class="variable">$host</span><span class="variable">$request_uri</span><span class="variable">$cookie_user</span>&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>缓存不应该设置的太敏感，可以使用<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_min_uses">proxy_cache_min_uses</a>设置相同的key的请求，访问次数超过指定数量才会被缓存。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_min_uses</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>默认情况下，响应无限期地保留在缓存中。仅当缓存超过最大配置大小时，按照时间删除最旧的数据。</p>
<h2 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h2><h4 id="1-轮循机制（round-robin）"><a href="#1-轮循机制（round-robin）" class="headerlink" title="1.轮循机制（round-robin）"></a>1.轮循机制（round-robin）</h4><p>默认机制，以轮循机制方式分发。</p>
<h4 id="2-最小连接（least-connected-）"><a href="#2-最小连接（least-connected-）" class="headerlink" title="2.最小连接（least-connected ）"></a>2.<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#least_conn">最小连接</a>（least-connected ）</h4><p>将下一个请求分配给活动连接数最少的服务器（较为空闲的服务器）。‎</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意，使用轮循机制或最少连接的负载平衡，每个客户端的请求都可能分发到不同的服务器。不能保证同一客户端将始终定向到同一服务器。‎</p>
<h4 id="3-ip-hash"><a href="#3-ip-hash" class="headerlink" title="3.ip-hash"></a>3.<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#ip_hash">ip-hash</a></h4><p>客户端的 IP 地址将用作哈希键，来自同一个ip的请求会被转发到相同的服务器。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此方法可确保来自同一客户端的请求将始终定向到同一服务器，除非此服务器不可用。‎</p>
<h4 id="‎4-hash"><a href="#‎4-hash" class="headerlink" title="‎4.hash"></a><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#hash">‎4.hash</a></h4><p>通用hash，允许用户自定义hash的key，key可以是字符串、变量或组合。</p>
<p>例如，key可以是配对的源 IP 地址和端口，也可以是 URI，如以下示例所示：‎</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">hash</span> <span class="variable">$request_uri</span> consistent;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意：基于 IP 的哈希算法存在一个问题，那就是当有一个上游服务器宕机或者扩容的时候，会引发大量的路由变更，进而引发连锁反应，导致大量缓存失效等问题。</p>
<p><code>consistent</code>参数启用 ‎<a target="_blank" rel="noopener" href="http://www.last.fm/user/RJ/journal/2007/04/10/rz_libketama_-_a_consistent_hashing_algo_for_memcache_clients">‎ketama‎</a>‎ 一致哈希算法，如果在上游组中添加或删除服务器，只会重新映射部分键，从而最大限度地减少缓存失效。‎</p>
<p>假设我们基于 key 来做 hash，现在有 4 台上游服务器，如果 hash 算法对 key 取模，请求根据用户定义的哈希键值均匀分布在所有上游服务器之间。当有一台服务器宕机的时候，就需要重新对 key 进行 hash，最后会发现所有的对应关系全都失效了，从而会引发缓存大范围失效。</p>
<h4 id="5-‎随机‎‎-random）"><a href="#5-‎随机‎‎-random）" class="headerlink" title="5.‎随机‎‎  (random）"></a>5.<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#random">‎随机‎</a>‎  (random）</h4><p>每个请求都将传递到随机选择的服务器。</p>
<p>two是可选参数，NGINX 在考虑服务器权重的情况下随机选择两台服务器，然后使用指定的方法选择其中一台，默认为选择连接数最少（least_conn‎）的服务器。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">random</span> two least_conn;</span><br><span class="line">    <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend2.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend3.example.com;</span><br><span class="line">    <span class="attribute">server</span> backend4.example.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="6-权重（weight）"><a href="#6-权重（weight）" class="headerlink" title="6.权重（weight）"></a>6.权重（weight）</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> my-server &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="attribute">server</span> performance.server weight=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server</span> app1.server;</span><br><span class="line">    <span class="attribute">server</span> app2.server;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>‎如上所示，每 5 个新请求将按如下方式分布在应用程序实例中：3 个请求将定向到performance.server，一个请求将转到app1.server，另一个请求将转到app2.server。‎</p>
<h4 id="7-健康检查"><a href="#7-健康检查" class="headerlink" title="7.健康检查"></a>7.健康检查</h4><p>在反向代理中，如果后端服务器在某个周期内响应失败次数超过规定值，nginx会将此服务器标记为失败，并在之后的一个周期不再将请求发送给这台服务器。‎</p>
<p>通过<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#fail_timeout">fail_timeout‎</a>‎ 来设置检查周期，默认为10秒。</p>
<p>通过<a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#max_fails">max_fails‎</a>来设置检查失败次数，默认为1次。‎</p>
<p>‎在以下示例中，如果NGINX无法向服务器发送请求或在30秒内请求失败次数超过3次，则会将服务器标记为不可用30秒。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">  <span class="attribute">server</span> backend1.example.com;</span><br><span class="line">  <span class="attribute">server</span> backend2.example.com max_fails=<span class="number">3</span> fail_timeout=<span class="number">30s</span>; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="HTTPS配置"><a href="#HTTPS配置" class="headerlink" title="HTTPS配置"></a>HTTPS配置</h2><p>HTTPS 协议是由HTTP 加上TLS&#x2F;SSL 协议构建的可进行加密传输、身份认证的网络协议，主要通过数字证书、加密算法、非对称密钥等技术完成互联网数据传输加密，实现互联网传输安全保护。</p>
<h3 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">openssl</span> genrsa -des3 -out server.key <span class="number">2048</span></span><br><span class="line"></span><br><span class="line">openssl req -new -key server.key -out server.csr</span><br><span class="line"></span><br><span class="line">openssl x509 -req -days <span class="number">365</span> -in server.csr -signkey server.key -out server.crt</span><br></pre></td></tr></table></figure>

<h3 id="配置ssl"><a href="#配置ssl" class="headerlink" title="配置ssl"></a>配置ssl</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">   <span class="attribute">listen</span>              <span class="number">443</span> ssl;</span><br><span class="line">   <span class="attribute">server_name</span>         ruoyi.https;</span><br><span class="line">   <span class="attribute">ssl_certificate</span>     /home/ssl/server.crt;</span><br><span class="line">   <span class="attribute">ssl_certificate_key</span> /home/ssl/server.key;</span><br><span class="line">   <span class="attribute">ssl_protocols</span>       TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br><span class="line">   <span class="attribute">ssl_ciphers</span>         HIGH:!aNULL:!MD5;</span><br><span class="line">   <span class="section">location</span> / &#123;</span><br><span class="line">       <span class="attribute">proxy_pass</span> http://localhost:8088;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如果设置了密码，需要加上</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">  ……</span><br><span class="line">  <span class="attribute">ssl_password_file</span>   /home/ssl/cert.pass;</span><br><span class="line">  ……</span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="https优化"><a href="#https优化" class="headerlink" title="https优化"></a>https优化</h3><p>SSL 操作会消耗额外的 CPU 资源。CPU 占用最多的操作是 SSL 握手。有两种方法可以最大程度地减少每个客户端的这些操作数：</p>
<p>●使保持活动连接能够通过一个连接发送多个请求</p>
<p>●重用 SSL 会话参数以避免并行连接和后续连接的 SSL 握手</p>
<p>会话存储在工作进程之间共享并由 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_session_cache">ssl_session_cache</a> 指令配置的 SSL 会话缓存中。一兆字节的缓存包含大约 4000 个会话。默认缓存超时为 5 分钟。可以使用 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_ssl_module.html#ssl_session_timeout">ssl_session_timeout</a> 指令增加此超时。以下是针对具有 10 MB 共享会话缓存的多核系统优化的示例配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_session_cache</span>   shared:SSL:<span class="number">10m</span>;</span><br><span class="line"><span class="attribute">ssl_session_timeout</span> <span class="number">10m</span>;</span><br></pre></td></tr></table></figure>

<h2 id="TCP反向代理"><a href="#TCP反向代理" class="headerlink" title="TCP反向代理"></a>TCP反向代理</h2><h3 id="stream"><a href="#stream" class="headerlink" title="stream"></a>stream</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#HTTP代理</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8002</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8080/;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#TCP代理</span></span><br><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">13306</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> localhost:<span class="number">3306</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="tcp负载均衡"><a href="#tcp负载均衡" class="headerlink" title="tcp负载均衡"></a>tcp负载均衡</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">stream</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="section">upstream</span> backend-mysql &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">3306</span>;</span><br><span class="line">    <span class="attribute">server</span> localhost:<span class="number">3307</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">keepalive</span> <span class="number">8</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">13306</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> backend-mysql;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>使用keepalive定义连接池里空闲连接的数量。</p>
<p>keepalive_timeout 默认60s。如果连接池里的连接空闲时间超过这个值，则连接关闭。</p>
<p>在最简单的 HTTP 实现中，客户端打开新连接，写入请求，读取响应，然后关闭连接以释放关联的资源。</p>
<p>在客户端读取响应后，保持连接处于打开状态，因此可以将其重新用于后续请求。</p>
<p>使用 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive">keepalive</a> 指令启用从 NGINX Plus 到上游服务器的保持活动连接，定义在每个工作进程的缓存中保留的与上游服务器的空闲保持活动连接的最大数量。当超过此数字时，将关闭最近最少使用的连接。如果没有 keepalives，您将增加更多的开销，并且连接和临时端口都效率低下。</p>
<p>现代 Web 浏览器通常会打开 6 到 8 个保持连接。</p>
<h2 id="重写-return和rewrite"><a href="#重写-return和rewrite" class="headerlink" title="重写(return和rewrite)"></a>重写(return和rewrite)</h2><p>nginx有两个重写指令：return和rewrite</p>
<h3 id="return"><a href="#return" class="headerlink" title="return"></a>return</h3><p>服务端停止处理并将状态码status code返回给客户端</p>
<p>return code URL</p>
<p>return code text</p>
<p>return code</p>
<p>return URL</p>
<p>强制所有请求使用Https </p>
<p>错误写法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">   <span class="attribute">listen</span> <span class="number">8003</span>;</span><br><span class="line">   <span class="attribute">server_name</span> ruoyi.loadbalance;</span><br><span class="line">   <span class="attribute">return</span> <span class="number">301</span> https://localhost:8004;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>正确写法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8003</span>;</span><br><span class="line">    <span class="attribute">server_name</span> ruoyi.loadbalance;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://192.168.56.105:8004;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="转发和重定向"><a href="#转发和重定向" class="headerlink" title="转发和重定向"></a>转发和重定向</h3><p>转发是服务端行为，重定向是客户端行为。</p>
<h3 id="转发"><a href="#转发" class="headerlink" title="转发"></a>转发</h3><p>发向代理proxy_pass属于转发，浏览器的访问栏输入的地址不会发生变化。</p>
<h3 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h3><p>return，rewrite属于重定向，在客户端进行。浏览器的访问栏输入的地址会发生变化。</p>
<p>域名迁移，不让用户收藏的链接或者搜索引擎的链接失效</p>
<p>将请求从 <a target="_blank" rel="noopener" href="http://www.old-name.com/">www.old-name.com</a> old-name.com 永久重定向到 <a target="_blank" rel="noopener" href="http://www.new-name.com,包含http和https请求/">www.new-name.com，包含http和https请求</a></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> www.old-name.com old-name.com;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> <span class="variable">$scheme</span>://www.new-name.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>由于捕获了域名后面的 URL 部分，因此，如果新旧网站之间存在一对一的页面对应关系（例如，<a target="_blank" rel="noopener" href="http://www.new-name.com/about">www.new-name.com/about</a> 具有与 <a target="_blank" rel="noopener" href="http://www.old-name.com/about">www.old-name.com/about</a> 相同的基本内容），则此重写是合适的。如果除了更改域名之外还重新组织了网站，则通过省略以下内容，将所有请求重定向到主页可能会更安全</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> www.old-name.com old-name.com;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> <span class="variable">$scheme</span>://www.new-name.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加www</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add &#x27;www&#x27;</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">server_name</span> domain.com;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> <span class="variable">$scheme</span>://www.domain.com<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h3><ul>
<li><p>2xx 成功</p>
</li>
<li><p>3xx 表示重定向</p>
<blockquote>
<p>301 永久重定向</p>
<p>302 临时重定向</p>
</blockquote>
</li>
<li><p>4xx 请求地址出错</p>
<blockquote>
<p>403 拒绝请求</p>
<p>404 请求找不到</p>
</blockquote>
</li>
<li><p>5xx 服务器内部错误</p>
</li>
</ul>
<h3 id="rewrite"><a href="#rewrite" class="headerlink" title="rewrite"></a>rewrite</h3><p>‎如果指定的正则表达式与请求 URI 匹配，则 URI 将按照字符串中的指定进行更改。指令按其在配置文件中出现的先后顺序执行。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^(/download/.*)/media/(\w+)\.?.*$</span> <span class="variable">$1</span>/mp3/<span class="variable">$2</span>.mp3 <span class="literal">last</span>;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^(/download/.*)/audio/(\w+)\.?.*$</span> <span class="variable">$1</span>/mp3/<span class="variable">$2</span>.ra  <span class="literal">last</span>;</span><br><span class="line">    <span class="attribute">return</span>  <span class="number">403</span>;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>上面是使用该指令的示例 NGINX 重写规则。它匹配以字符串 &#x2F;download 开头的 URL，然后在路径后面的某个位置包含 &#x2F;media&#x2F; 或 &#x2F;audio&#x2F; 目录。它将这些元素替换为 &#x2F;mp3&#x2F;，并添加相应的文件扩展名，.mp3 或 .ra。和 变量捕获未更改的路径元素。例如，&#x2F;download&#x2F;cdn-west&#x2F;media&#x2F;file1 变成了 &#x2F;download&#x2F;cdn-west&#x2F;mp3&#x2F;file1.mp3。如果文件名上有扩展名（如 .flv），则表达式会将其剥离，并将其替换为.mp3。</p>
<p>如果字符串包含新的请求参数，则以前的请求参数将追加到这些参数之后。如果不需要这样做，则在替换字符串的末尾放置一个问号可以避免附加它们，例如：replacement</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/users/(.*)$</span> /show?user=<span class="variable">$1</span>? <span class="literal">last</span>;</span><br></pre></td></tr></table></figure>

<h3 id="last与break"><a href="#last与break" class="headerlink" title="last与break"></a>last与break</h3><p>last：如果当前规则不匹配，停止处理后续rewrite规则，使用重写后的路径，重新搜索location及其块内指令</p>
<p>break:如果当前规则不匹配，停止处理后续rewrite规则，执行{}块内其他指令</p>
<h3 id="不使用last和break"><a href="#不使用last和break" class="headerlink" title="不使用last和break"></a>不使用last和break</h3><p>在root &#x2F;home&#x2F;AdminLTE-3.2.0&#x2F;pages下创建一个1.txt，里面内容是this is a file</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8000</span>;</span><br><span class="line">    <span class="attribute">server_name</span> nginx-dev;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">rewrite_log</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/old/(.*)</span> /new/<span class="variable">$1</span>;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/new/(.*)</span> /pages/<span class="variable">$1</span>;</span><br><span class="line">        <span class="comment">#根目录</span></span><br><span class="line">        <span class="attribute">root</span> /home/AdminLTE-<span class="number">3</span>.<span class="number">2</span>.<span class="number">0</span>;</span><br><span class="line">        <span class="comment">#首页</span></span><br><span class="line">        <span class="attribute">index</span> index.html index2.html index3.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span>  /pages/<span class="number">1</span>.txt &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;this is rewrite test!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>默认按顺序执行。</p>
<p>访问 <a target="_blank" rel="noopener" href="http://192.168.56.105:8000/old/1.txt">http://192.168.56.105:8000/old/1.txt</a></p>
<p>结果：this is rewrite test!</p>
<p>日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[notice] 26837#26837: *1181 &quot;^/old/(.*)&quot; matches &quot;/old/1.txt&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[notice] 26837#26837: *1181 rewritten data: &quot;/new/1.txt&quot;, args: &quot;&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[notice] 26837#26837: *1181 &quot;^/new/(.*)&quot; matches &quot;/new/1.txt&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[notice] 26837#26837: *1181 rewritten data: &quot;/pages/1.txt&quot;, args: &quot;&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br></pre></td></tr></table></figure>

<h3 id="使用break"><a href="#使用break" class="headerlink" title="使用break"></a>使用break</h3><p>访问 <a target="_blank" rel="noopener" href="http://192.168.56.105:8000/old/1.txt">http://192.168.56.105:8000/old/1.txt</a></p>
<p>1.匹配到了rewrite ^&#x2F;old&#x2F;(.*) &#x2F;new&#x2F;$1</p>
<p>2.break指令不执行后续的rewrite规则,以新的&#x2F;new&#x2F;1.txt路径去执行块内的其他指令</p>
<ol start="3">
<li>去root目录下寻找文件, 由于不再村&#x2F;home&#x2F;AdminLTE-3.2.0&#x2F;new&#x2F;1.txt这个文件，返回404</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8000</span>;</span><br><span class="line">    <span class="attribute">server_name</span> nginx-dev;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">rewrite_log</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/old/(.*)</span> /new/<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/new/(.*)</span> /pages/<span class="variable">$1</span>;</span><br><span class="line">        <span class="comment">#根目录</span></span><br><span class="line">        <span class="attribute">root</span> /home/AdminLTE-<span class="number">3</span>.<span class="number">2</span>.<span class="number">0</span>;</span><br><span class="line">        <span class="comment">#首页</span></span><br><span class="line">        <span class="attribute">index</span> index.html index2.html index3.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span>  /pages/<span class="number">1</span>.txt &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;this is rewrite test!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 <a target="_blank" rel="noopener" href="http://192.168.56.105:8000/old/1.txt%EF%BC%8C%E5%87%BA%E7%8E%B0404%E7%9A%84%E7%BB%93%E6%9E%9C%EF%BC%8C%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97%EF%BC%9A">http://192.168.56.105:8000/old/1.txt，出现404的结果，访问日志：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[notice] 26772#26772: *1179 &quot;^/old/(.*)&quot; matches &quot;/old/1.txt&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[notice] 26772#26772: *1179 rewritten data: &quot;/new/1.txt&quot;, args: &quot;&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[error] 26772#26772: *1179 open() &quot;/home/AdminLTE-3.2.0/new/1.txt&quot; failed (2: No such file or directory), client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br></pre></td></tr></table></figure>

<h3 id="使用last"><a href="#使用last" class="headerlink" title="使用last"></a>使用last</h3><p>访问 <a target="_blank" rel="noopener" href="http://192.168.56.105:8000/old/1.txt">http://192.168.56.105:8000/old/1.txt</a></p>
<p>1.匹配到了rewrite ^&#x2F;old&#x2F;(.*) &#x2F;new&#x2F;$1</p>
<p>2.last指令不执行后续的rewrite规则,以新的&#x2F;new&#x2F;1.txt路径去匹配location</p>
<p>3.先匹配到location &#x2F;, 有匹配到location里的rewrite ^&#x2F;new&#x2F;(.*) &#x2F;pages&#x2F;$1规则，重定向到</p>
<p>&#x2F;pages&#x2F;1.txt</p>
<p>4.匹配到了location &#x2F;pages&#x2F;1.txt ，于是返回了this is rewrite test!</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8000</span>;</span><br><span class="line">    <span class="attribute">server_name</span> nginx-dev;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">rewrite_log</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/old/(.*)</span> /new/<span class="variable">$1</span> <span class="literal">last</span>;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/new/(.*)</span> /pages/<span class="variable">$1</span>;</span><br><span class="line">        <span class="comment">#根目录</span></span><br><span class="line">        <span class="attribute">root</span> /home/AdminLTE-<span class="number">3</span>.<span class="number">2</span>.<span class="number">0</span>;</span><br><span class="line">        <span class="comment">#首页</span></span><br><span class="line">        <span class="attribute">index</span> index.html index2.html index3.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span>  /pages/<span class="number">1</span>.txt &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;this is rewrite test!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 <a target="_blank" rel="noopener" href="http://192.168.56.105:8000/old/1.txt">http://192.168.56.105:8000/old/1.txt</a></p>
<p>结果：this is rewrite test!</p>
<p>日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[notice] 26969#26969: *1185 &quot;^/old/(.*)&quot; matches &quot;/old/1.txt&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[notice] 26969#26969: *1185 rewritten data: &quot;/new/1.txt&quot;, args: &quot;&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[notice] 26969#26969: *1185 &quot;^/old/(.*)&quot; does not match &quot;/new/1.txt&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[notice] 26969#26969: *1185 &quot;^/new/(.*)&quot; matches &quot;/new/1.txt&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br><span class="line">[notice] 26969#26969: *1185 rewritten data: &quot;/pages/1.txt&quot;, args: &quot;&quot;, client: 192.168.56.1, server: nginx-dev, request: &quot;GET /old/1.txt HTTP/1.1&quot;, host: &quot;192.168.56.105:8000&quot;</span><br></pre></td></tr></table></figure>

<h2 id="其他常见指令"><a href="#其他常见指令" class="headerlink" title="其他常见指令"></a>其他常见指令</h2><h3 id="gzip压缩"><a href="#gzip压缩" class="headerlink" title="gzip压缩"></a>gzip压缩</h3><p>压缩响应通常会显著减小传输数据的大小。但是，由于压缩发生在运行时，因此它还会增加相当大的处理开销，从而对性能产生负面影响。NGINX在将响应发送到客户端之前执行压缩，但如果后端服务器已经对内容进行了压缩，则nginx不会再压缩。</p>
<p>若要启用压缩，请在参数中包含 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip">gzip</a> 指令。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>; </span><br><span class="line"><span class="attribute">gzip_types</span> text/plain application/xml; </span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">1000</span>; </span><br></pre></td></tr></table></figure>



<p>默认情况下，NGINX仅使用压缩MIME类型是text&#x2F;html的响应。若要使用其他 MIME 类型压缩响应，可以使用 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_types">gzip_types</a> 指令并列出其他类型。</p>
<p>若要指定压缩响应的最小长度，请使用 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_min_length">gzip_min_length</a> 指令。默认值为 20 个字节（此处调整为 1000)。</p>
<h3 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h3><p>默认情况下，NGINX处理文件传输本身，并在发送之前将文件复制到缓冲区中。启用 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile">sendfile</a> 指令可消除将数据复制到缓冲区的步骤，直接将一个文件复制到另一个文件。</p>
<p>启用sendfile，类似Java中的零拷贝（zero copy）</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /download &#123;</span><br><span class="line">  <span class="attribute">sendfile</span>           <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">tcp_nopush</span>         <span class="literal">on</span>; </span><br><span class="line">  <span class="comment">#... </span></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>将 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#tcp_nopush">tcp_nopush</a> 指令与 <a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile">sendfile</a> 指令一起使用。这使NGINX能够在获得数据块后立即在一个数据包中发送HTTP响应标头。</p>
<h3 id="try-files"><a href="#try-files" class="headerlink" title="try_files"></a>try_files</h3><p><a target="_blank" rel="noopener" href="https://nginx.org/en/docs/http/ngx_http_core_module.html#try_files">try_files</a>指令可用于检查指定的文件或目录是否存在;如果不存在，则重定向到指定位置。</p>
<p>如下，如果原始URI对应的文件不存在，NGINX将内部重定向到&#x2F;www&#x2F;data&#x2F;images&#x2F;default.gif</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /www/data;</span><br><span class="line">    <span class="section">location</span> /images/ &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> /images/default.gif;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最后一个参数也可以是状态代码（状态码之前需要加上等号）。</p>
<p>在下面的示例中，如果指令的所有参数都无法解析为现有文件或目录，则会返回404错误。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ <span class="variable">$uri</span>.html =<span class="number">404</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在下一个示例中，如果原始 URI 和附加尾随斜杠的 URI 都没有解析到现有文件或目录中，则请求将重定向到命名位置，该位置会将其传递到代理服务器。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ <span class="variable">@backend</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> <span class="variable">@backend</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://backend.example.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="error-page"><a href="#error-page" class="headerlink" title="error_page"></a>error_page</h3><p>为错误指定显示的页面。值可以包含变量。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">error_page</span> <span class="number">404</span>             /<span class="number">404</span>.html; </span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br></pre></td></tr></table></figure>

<h2 id="推荐写法及注意事项"><a href="#推荐写法及注意事项" class="headerlink" title="推荐写法及注意事项"></a>推荐写法及注意事项</h2><h3 id="一、推荐写法"><a href="#一、推荐写法" class="headerlink" title="一、推荐写法"></a>一、推荐写法</h3><h4 id="1-重复的配置可继承自父级"><a href="#1-重复的配置可继承自父级" class="headerlink" title="1.重复的配置可继承自父级"></a>1.重复的配置可继承自父级</h4><p>例如：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">  </span><br><span class="line">  <span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">root</span> /var/www/nginx-default/;</span><br><span class="line">    <span class="comment"># [...]</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">location</span> /foo &#123;</span><br><span class="line">    <span class="attribute">root</span> /var/www/nginx-default/;</span><br><span class="line">    <span class="comment"># [...]</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="section">location</span> /bar &#123;</span><br><span class="line">    <span class="attribute">root</span> /some/other/place;</span><br><span class="line">  <span class="comment"># [...]</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>推荐写法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">server_name</span> www.example.com;</span><br><span class="line">    <span class="attribute">root</span> /var/www/nginx-default/;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="comment"># root继承父级配置</span></span><br><span class="line">        <span class="comment"># [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /foo &#123;</span><br><span class="line">        <span class="comment"># root继承父级配置</span></span><br><span class="line">        <span class="comment"># [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /bar &#123;</span><br><span class="line">        <span class="comment"># 覆盖</span></span><br><span class="line">        <span class="attribute">root</span> /some/other/place;</span><br><span class="line">        <span class="comment"># [...]</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这样在添加新的location时，可以避免重复配置。</p>
<h4 id="2-不要将所有请求都代理到后端服务器"><a href="#2-不要将所有请求都代理到后端服务器" class="headerlink" title="2.不要将所有请求都代理到后端服务器"></a>2.不要将所有请求都代理到后端服务器</h4><p>不推荐：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://localhost:8088;        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>考虑到很多请求是访问静态内容（如图片，css，javascript等文件）,可以使用缓存或者配置静态目录来减少发送到后端的请求数量，这样可以减小后端服务器的开销。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8002</span>;</span><br><span class="line">    <span class="attribute">server_name</span> ruoyi.tomcat;</span><br><span class="line">    <span class="attribute">root</span> /home/www/static;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ <span class="variable">@proxy</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">location</span> <span class="variable">@proxy</span> &#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://localhost:8080;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-若非必要，不要缓存动态请求，只缓存静态文件"><a href="#3-若非必要，不要缓存动态请求，只缓存静态文件" class="headerlink" title="3.若非必要，不要缓存动态请求，只缓存静态文件"></a>3.若非必要，不要缓存动态请求，只缓存静态文件</h4><p>nginx关于缓存的指令非常多</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache">proxy_cache</a></li>
<li>[proxy_cache_background_update</li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_bypass">proxy_cache_bypass</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_convert_head">proxy_cache_convert_head</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_key">proxy_cache_key</a>    </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_lock">proxy_cache_lock</a>    </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_lock_age">proxy_cache_lock_age</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_lock_timeout">proxy_cache_lock_timeout</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_max_range_offset">proxy_cache_max_range_offset</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_methods">proxy_cache_methods</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_min_uses">proxy_cache_min_uses</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path">proxy_cache_path</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_purge">proxy_cache_purge</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_revalidate">proxy_cache_revalidate</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_use_stale">proxy_cache_use_stale</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_valid">proxy_cache_valid</a>     </li>
<li><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_no_cache">proxy_no_cache</a></li>
</ul>
<p>由于nginx服务端缓存非常复杂，在使用缓存的时候，我们要清楚的知道在什么条件下，哪些文件会被缓存。</p>
<p>在配置文件中，最好能够清晰的指定哪些文件使用缓存。</p>
<h4 id="4-检查文件是否存在使用try-files代替if-f"><a href="#4-检查文件是否存在使用try-files代替if-f" class="headerlink" title="4.检查文件是否存在使用try_files代替if -f"></a>4.检查文件是否存在使用try_files代替if -f</h4><p>不推荐用法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /var/www/example.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">if</span> (!-f <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>推荐用法：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">root</span> /var/www/example.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="5-在重写路径中包含http-x2F-x2F-或https-x2F-x2F"><a href="#5-在重写路径中包含http-x2F-x2F-或https-x2F-x2F" class="headerlink" title="5.在重写路径中包含http:&#x2F;&#x2F;或https:&#x2F;&#x2F;"></a>5.在重写路径中包含http:&#x2F;&#x2F;或https:&#x2F;&#x2F;</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#推荐写法</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^</span> http://example.com <span class="literal">permanent</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">#不推荐的写法</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^</span> example.com <span class="literal">permanent</span>; </span><br></pre></td></tr></table></figure>

<h4 id="6-保持重写规则简单干净"><a href="#6-保持重写规则简单干净" class="headerlink" title="6.保持重写规则简单干净"></a>6.保持重写规则简单干净</h4><p>例如下面的这个例子可以变得更简单易懂。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#复杂的写法</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^/(.*)$</span> http://example.com/<span class="variable">$1</span> <span class="literal">permanent</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">#简单有效的写法</span></span><br><span class="line"><span class="attribute">rewrite</span><span class="regexp"> ^</span> http://example.com<span class="variable">$request_uri</span>? <span class="literal">permanent</span>; </span><br><span class="line"><span class="attribute">return</span> <span class="number">301</span> http://example.com<span class="variable">$request_uri</span>; </span><br></pre></td></tr></table></figure>

<h3 id="二、注意事项"><a href="#二、注意事项" class="headerlink" title="二、注意事项"></a>二、注意事项</h3><h4 id="1-正确的配置未生效，请清除浏览器缓存"><a href="#1-正确的配置未生效，请清除浏览器缓存" class="headerlink" title="1.正确的配置未生效，请清除浏览器缓存"></a>1.正确的配置未生效，请清除浏览器缓存</h4><p>当你确定修改的配置的正确的，但是未生效，请清除浏览器缓存或者禁用浏览器缓存。</p>
<h4 id="2-在HTTPS中不启用-SSLv3"><a href="#2-在HTTPS中不启用-SSLv3" class="headerlink" title="2.在HTTPS中不启用 SSLv3"></a>2.在HTTPS中不启用 SSLv3</h4><p>由于 SSLv3 中存在 POODLE 漏洞，建议不要在启用了 SSL 的站点中使用 SSLv3。您可以使用以下行非常轻松地禁用 SSLv3，并仅提供 TLS 协议：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<h4 id="3-不要将-root-目录配置成-x2F-或-x2F-root。"><a href="#3-不要将-root-目录配置成-x2F-或-x2F-root。" class="headerlink" title="3.不要将 root 目录配置成 &#x2F;或 &#x2F;root。"></a>3.不要将 root 目录配置成 &#x2F;或 &#x2F;root。</h4><p>错误用法</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="comment">#错误用法</span></span><br><span class="line">  <span class="attribute">root</span> /;</span><br><span class="line">  </span><br><span class="line">  <span class="section">location</span> /project/path &#123;</span><br><span class="line">    <span class="comment">#错误用法</span></span><br><span class="line">    <span class="attribute">root</span> /root;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-谨慎使用chmod-777"><a href="#4-谨慎使用chmod-777" class="headerlink" title="4.谨慎使用chmod 777"></a>4.谨慎使用chmod 777</h4><p>这可能是解决问题最简单的方式，同时也说明，你没有真的弄清楚哪里出了问题。</p>
<p>可以使用namei -om &#x2F;path&#x2F;to&#x2F;check显示路径上的所有权限，并找到问题的根本原因。</p>
<h4 id="5-不要将部署的项目拷贝到默认目录下"><a href="#5-不要将部署的项目拷贝到默认目录下" class="headerlink" title="5.不要将部署的项目拷贝到默认目录下"></a>5.不要将部署的项目拷贝到默认目录下</h4><p>升级或更新nginx的时候，默认目录可能被覆盖。</p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/wukong-zorrm/cql6cz/ofesua#FlVqs">查考文章</a></p>
</div><div class="article-licensing box"><div class="licensing-title"><p>nginx配置</p><p><a href="https://ihuan123.github.io/note/2024/12/03/nginx配置/">https://ihuan123.github.io/note/2024/12/03/nginx配置/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>IHuan123</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2024-12-03</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-12-04</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><hr style="height:1px;margin:1rem 0"><div class="level is-mobile is-flex"></div><div style="display:flex;justify-content:space-between;align-items:center;"><div class="article-tags is-size-7 is-uppercase"><i class="fas fa-tags has-text-grey"></i> <a class="link-muted" rel="tag" href="/note/tags/nginx/">nginx </a></div></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/note/2022/07/19/vuex%E9%9D%A2%E8%AF%95%E9%A2%98/"><span class="level-item">vuex面试题</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "b98feace508aa3ad92cab37854a0e71e",
            repo: "blog",
            owner: "IHuan123",
            clientID: "67c282af028dafe35991",
            clientSecret: "c97915ab7ba1661603bf54146da66c41b8124014",
            admin: ["IHuan123"],
            createIssueManually: true,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            language: "zh-CN",
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://avatars.githubusercontent.com/u/42716044?v=4" alt="wanghuan"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">wanghuan</p><p class="is-size-6 is-block">super_huan@outlook.com</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>成都</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/note/archives"><p class="title">17</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/note/categories"><p class="title">12</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/note/tags"><p class="title">11</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/IHuan123" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/IHuan123"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Nginx安装"><span class="level-left"><span class="level-item">1</span><span class="level-item">Nginx安装</span></span></a></li><li><a class="level is-mobile" href="#常用命令"><span class="level-left"><span class="level-item">2</span><span class="level-item">常用命令</span></span></a></li><li><a class="level is-mobile" href="#默认配置文件"><span class="level-left"><span class="level-item">3</span><span class="level-item">默认配置文件</span></span></a></li><li><a class="level is-mobile" href="#配置文件"><span class="level-left"><span class="level-item">4</span><span class="level-item">配置文件</span></span></a></li><li><a class="level is-mobile" href="#HTTP反向代理"><span class="level-left"><span class="level-item">5</span><span class="level-item">HTTP反向代理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#proxy-pass"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">proxy_pass</span></span></a></li><li><a class="level is-mobile" href="#设置headers代理请求"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">设置headers代理请求</span></span></a></li><li><a class="level is-mobile" href="#非HTTP代理"><span class="level-left"><span class="level-item">5.3</span><span class="level-item">非HTTP代理</span></span></a></li></ul></li><li><a class="level is-mobile" href="#动静分离"><span class="level-left"><span class="level-item">6</span><span class="level-item">动静分离</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#location"><span class="level-left"><span class="level-item">6.1</span><span class="level-item">location</span></span></a></li></ul></li><li><a class="level is-mobile" href="#缓冲（buffer）、缓存（cache）"><span class="level-left"><span class="level-item">7</span><span class="level-item">缓冲（buffer）、缓存（cache）</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#缓冲（buffer）"><span class="level-left"><span class="level-item">7.1</span><span class="level-item">缓冲（buffer）</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#proxy-buffering"><span class="level-left"><span class="level-item">7.1.1</span><span class="level-item">proxy_buffering</span></span></a></li><li><a class="level is-mobile" href="#proxy-buffers"><span class="level-left"><span class="level-item">7.1.2</span><span class="level-item">proxy_buffers</span></span></a></li></ul></li><li><a class="level is-mobile" href="#缓存（cache）"><span class="level-left"><span class="level-item">7.2</span><span class="level-item">缓存（cache）</span></span></a></li></ul></li><li><a class="level is-mobile" href="#负载均衡策略"><span class="level-left"><span class="level-item">8</span><span class="level-item">负载均衡策略</span></span></a><ul class="menu-list"><ul class="menu-list"><li><a class="level is-mobile" href="#1-轮循机制（round-robin）"><span class="level-left"><span class="level-item">8.1.1</span><span class="level-item">1.轮循机制（round-robin）</span></span></a></li><li><a class="level is-mobile" href="#2-最小连接（least-connected-）"><span class="level-left"><span class="level-item">8.1.2</span><span class="level-item">2.最小连接（least-connected ）</span></span></a></li><li><a class="level is-mobile" href="#3-ip-hash"><span class="level-left"><span class="level-item">8.1.3</span><span class="level-item">3.ip-hash</span></span></a></li><li><a class="level is-mobile" href="#‎4-hash"><span class="level-left"><span class="level-item">8.1.4</span><span class="level-item">‎4.hash</span></span></a></li><li><a class="level is-mobile" href="#5-‎随机‎‎-random）"><span class="level-left"><span class="level-item">8.1.5</span><span class="level-item">5.‎随机‎‎  (random）</span></span></a></li><li><a class="level is-mobile" href="#6-权重（weight）"><span class="level-left"><span class="level-item">8.1.6</span><span class="level-item">6.权重（weight）</span></span></a></li><li><a class="level is-mobile" href="#7-健康检查"><span class="level-left"><span class="level-item">8.1.7</span><span class="level-item">7.健康检查</span></span></a></li></ul></ul></li><li><a class="level is-mobile" href="#HTTPS配置"><span class="level-left"><span class="level-item">9</span><span class="level-item">HTTPS配置</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#生成证书"><span class="level-left"><span class="level-item">9.1</span><span class="level-item">生成证书</span></span></a></li><li><a class="level is-mobile" href="#配置ssl"><span class="level-left"><span class="level-item">9.2</span><span class="level-item">配置ssl</span></span></a></li><li><a class="level is-mobile" href="#https优化"><span class="level-left"><span class="level-item">9.3</span><span class="level-item">https优化</span></span></a></li></ul></li><li><a class="level is-mobile" href="#TCP反向代理"><span class="level-left"><span class="level-item">10</span><span class="level-item">TCP反向代理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#stream"><span class="level-left"><span class="level-item">10.1</span><span class="level-item">stream</span></span></a></li><li><a class="level is-mobile" href="#tcp负载均衡"><span class="level-left"><span class="level-item">10.2</span><span class="level-item">tcp负载均衡</span></span></a></li></ul></li><li><a class="level is-mobile" href="#重写-return和rewrite"><span class="level-left"><span class="level-item">11</span><span class="level-item">重写(return和rewrite)</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#return"><span class="level-left"><span class="level-item">11.1</span><span class="level-item">return</span></span></a></li><li><a class="level is-mobile" href="#转发和重定向"><span class="level-left"><span class="level-item">11.2</span><span class="level-item">转发和重定向</span></span></a></li><li><a class="level is-mobile" href="#转发"><span class="level-left"><span class="level-item">11.3</span><span class="level-item">转发</span></span></a></li><li><a class="level is-mobile" href="#重定向"><span class="level-left"><span class="level-item">11.4</span><span class="level-item">重定向</span></span></a></li><li><a class="level is-mobile" href="#状态码"><span class="level-left"><span class="level-item">11.5</span><span class="level-item">状态码</span></span></a></li><li><a class="level is-mobile" href="#rewrite"><span class="level-left"><span class="level-item">11.6</span><span class="level-item">rewrite</span></span></a></li><li><a class="level is-mobile" href="#last与break"><span class="level-left"><span class="level-item">11.7</span><span class="level-item">last与break</span></span></a></li><li><a class="level is-mobile" href="#不使用last和break"><span class="level-left"><span class="level-item">11.8</span><span class="level-item">不使用last和break</span></span></a></li><li><a class="level is-mobile" href="#使用break"><span class="level-left"><span class="level-item">11.9</span><span class="level-item">使用break</span></span></a></li><li><a class="level is-mobile" href="#使用last"><span class="level-left"><span class="level-item">11.10</span><span class="level-item">使用last</span></span></a></li></ul></li><li><a class="level is-mobile" href="#其他常见指令"><span class="level-left"><span class="level-item">12</span><span class="level-item">其他常见指令</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#gzip压缩"><span class="level-left"><span class="level-item">12.1</span><span class="level-item">gzip压缩</span></span></a></li><li><a class="level is-mobile" href="#sendfile"><span class="level-left"><span class="level-item">12.2</span><span class="level-item">sendfile</span></span></a></li><li><a class="level is-mobile" href="#try-files"><span class="level-left"><span class="level-item">12.3</span><span class="level-item">try_files</span></span></a></li><li><a class="level is-mobile" href="#error-page"><span class="level-left"><span class="level-item">12.4</span><span class="level-item">error_page</span></span></a></li></ul></li><li><a class="level is-mobile" href="#推荐写法及注意事项"><span class="level-left"><span class="level-item">13</span><span class="level-item">推荐写法及注意事项</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#一、推荐写法"><span class="level-left"><span class="level-item">13.1</span><span class="level-item">一、推荐写法</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-重复的配置可继承自父级"><span class="level-left"><span class="level-item">13.1.1</span><span class="level-item">1.重复的配置可继承自父级</span></span></a></li><li><a class="level is-mobile" href="#2-不要将所有请求都代理到后端服务器"><span class="level-left"><span class="level-item">13.1.2</span><span class="level-item">2.不要将所有请求都代理到后端服务器</span></span></a></li><li><a class="level is-mobile" href="#3-若非必要，不要缓存动态请求，只缓存静态文件"><span class="level-left"><span class="level-item">13.1.3</span><span class="level-item">3.若非必要，不要缓存动态请求，只缓存静态文件</span></span></a></li><li><a class="level is-mobile" href="#4-检查文件是否存在使用try-files代替if-f"><span class="level-left"><span class="level-item">13.1.4</span><span class="level-item">4.检查文件是否存在使用try_files代替if -f</span></span></a></li><li><a class="level is-mobile" href="#5-在重写路径中包含http-x2F-x2F-或https-x2F-x2F"><span class="level-left"><span class="level-item">13.1.5</span><span class="level-item">5.在重写路径中包含http://或https://</span></span></a></li><li><a class="level is-mobile" href="#6-保持重写规则简单干净"><span class="level-left"><span class="level-item">13.1.6</span><span class="level-item">6.保持重写规则简单干净</span></span></a></li></ul></li><li><a class="level is-mobile" href="#二、注意事项"><span class="level-left"><span class="level-item">13.2</span><span class="level-item">二、注意事项</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-正确的配置未生效，请清除浏览器缓存"><span class="level-left"><span class="level-item">13.2.1</span><span class="level-item">1.正确的配置未生效，请清除浏览器缓存</span></span></a></li><li><a class="level is-mobile" href="#2-在HTTPS中不启用-SSLv3"><span class="level-left"><span class="level-item">13.2.2</span><span class="level-item">2.在HTTPS中不启用 SSLv3</span></span></a></li><li><a class="level is-mobile" href="#3-不要将-root-目录配置成-x2F-或-x2F-root。"><span class="level-left"><span class="level-item">13.2.3</span><span class="level-item">3.不要将 root 目录配置成 /或 /root。</span></span></a></li><li><a class="level is-mobile" href="#4-谨慎使用chmod-777"><span class="level-left"><span class="level-item">13.2.4</span><span class="level-item">4.谨慎使用chmod 777</span></span></a></li><li><a class="level is-mobile" href="#5-不要将部署的项目拷贝到默认目录下"><span class="level-left"><span class="level-item">13.2.5</span><span class="level-item">5.不要将部署的项目拷贝到默认目录下</span></span></a></li></ul></li></ul></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/note/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer test-css"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/note/"><img src="/note/img/logo.svg" alt="wanghuan" height="28"></a><p class="is-size-7"><span>&copy; 2024 IHuan123</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/IHuan123"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/note/js/column.js"></script><script src="/note/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/note/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/note/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/note/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/note/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>